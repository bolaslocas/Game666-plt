

<html>
<head>
    <title>Google Login</title>
    
    <script src="lib/firebasejs_7.22.0.js" ></script>
    <script src="lib/getCountry.js" ></script>
    
    <script>
    
    
       const urlParams = new URLSearchParams(window.location.search);
    const logout = urlParams.get("out");
     const token = urlParams.get("token");
    //window.close = function(){}
        // إعداد Firebase
    const firebaseConfig = {
    apiKey: "AIzaSyCe-q_-S7K0dDOG31uXSfw7hPf4eKAMx5o",
    authDomain: "loginpoolplus.firebaseapp.com",
    projectId: "loginpoolplus",
    storageBucket: "loginpoolplus.appspot.com",
    messagingSenderId: "492722867198",
    appId: "1:492722867198:web:059051cda17622c06c0eaf",
    measurementId: "G-87MESN2K3H"
  };

              function sendDataToDroidScript(data) {
                   
                              var ws =  new WebSocket( "ws://" + location.host ); // استبدل بـ IP جهاز DroidScript

          ws.onopen = function() {
             
                ws.send(JSON.stringify(data)); // إرسال البيانات بتنسيق JSON
               // console.log("تم إرسال البيانات إلى DroidScript");
               
               setTimeout(()=>{
                    window.close()
                    },300)
            };
              ws.onerror = function() {
              
                window.close()
            };
            
             ws.onclose = function() {
                   
                window.close()
            };
        }
        
 let welcome=false
let googleSignInButton = false
 
 let userData = false
const app = firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();

if( logout=="true"){
    //alert(logout)
    firebase.auth().signOut().then(()=>{
   window.close()
    
})

 setInterval(()=>{
                    window.close()
                    },500)
                    
    }else{
        
           // اختياري لكن مهم للآيفون: تحديد الـ Persistence
   auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
   .then(() => {
     
      auth.onAuthStateChanged(user => {
    
        if (user && userData===false ) {
               var data = {
                    displayName: user.displayName,
                    email: user.email
                };
             
           //  alert(user)
            //alert(22)
               // سحب البيانات المهمة
               const uid = user.providerData[0]?.uid;
               const name = user.providerData[0]?.displayName;
               const email = user.email;
               const photo = user.photoURL;
               const emailVerified = user.emailVerified;
               const providerId = user.providerData[0]?.providerId;
               const country = getCountry();
              //console.log('UID:', uid);
              //console.log('الاسم:', name);
               //console.log('البريد الإلكتروني:', email);
              // console.log('رابط الصورة:', photo);
              // console.log('البريد موثّق؟', emailVerified);
              // console.log('تم الدخول عن طريق:', providerId);
              //console.log('المدينة', getCountry());
         userData = {uid,name,email,photo,country,emailVerified,providerId,token:token}
       
                       sendDataToDroidScript(userData);

        // phaserInit()
                 

        }else{
             signInWithGoogle()
        }
    });
 
   })
   .catch((error) => {
    
     console.error('Persistence Error:', error);
   });
 
        }

// تسجيل الدخول عبر جوجل

 

 
        function signInWithGoogle() {
          const provider = new firebase.auth.GoogleAuthProvider();
			provider.addScope('profile');
		  provider.addScope('email');
		  provider.setCustomParameters({
			prompt: 'select_account'
		 });  
            signInWithProvider(provider).then(function(result) {
                var user = result.user;
                console.log("تم تسجيل الدخول كـ: " + user.displayName);
                console.log("البريد الإلكتروني: " + user.email);

                 const uid = user.providerData[0]?.uid;
               const name = user.providerData[0]?.displayName;
               const email = user.email;
               const photo = user.photoURL;
               const emailVerified = user.emailVerified;
               const providerId = user.providerData[0]?.providerId;
               const country = getCountry();
              //console.log('UID:', uid);
              //console.log('الاسم:', name);
               //console.log('البريد الإلكتروني:', email);
              // console.log('رابط الصورة:', photo);
              // console.log('البريد موثّق؟', emailVerified);
              // console.log('تم الدخول عن طريق:', providerId);
              //console.log('المدينة', getCountry());
         userData = {uid,name,email,photo,country,emailVerified,providerId,token:token}
               // sendDataToDroidScript(userData);
            }).catch(function(error) {
               
                console.log("حدث خطأ أثناء تسجيل الدخول: " + error.message)
                 //window.close();
            });
        }
           async function signInWithProvider(provider) {
		try {
	  
			// أول شيء: هل رجع من Redirect؟ نحاول نجيب النتيجة
			const redirectResult = await auth.getRedirectResult();
			if (redirectResult.user) {
				// console.log('Signed in with Redirect (after return)', redirectResult);
				return redirectResult;
			}
		const result = await auth.signInWithPopup(provider);
				//console.log('Signed in with Popup (Desktop)', result);
				return result;
			// لو ما في نتيجة، نكمل التسجيل الطبيعي حسب الجهاز
			if (RUNNING_ON_DESKTOP) {
				const result = await auth.signInWithPopup(provider);
				//console.log('Signed in with Popup (Desktop)', result);
				return result;
			} else if (RUNNING_ON_IOS) {
				const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
				if (isSafari) {
					// Safari لا يدعم Popup كويس
					await auth.signInWithPopup(provider);
					//console.log('Started Redirect Sign-in (iOS Safari)');
				} else {
					const result = await auth.signInWithPopup(provider);
					//console.log('Signed in with Popup (iOS non-Safari)', result);
					return result;
				}
			} else {
				await auth.signInWithPopup(provider);
				//console.log('Started Redirect Sign-in (Mobile/Other)');
			}
		} catch (error) {
			console.error('Error during sign-in:', error);
			// window.close();
		//	throw error;
			
		}
	}

        // إرسال البيانات إلى DroidScript عبر WebSocket
  
    </script>
</head>
<body>
     
</body>
</html>
